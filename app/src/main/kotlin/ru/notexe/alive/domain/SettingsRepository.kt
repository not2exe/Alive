package ru.notexe.alive.domain

import androidx.compose.ui.geometry.Offset
import androidx.room.withTransaction
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.withContext
import kotlinx.serialization.json.Json
import ru.notexe.alive.data.FramesDao
import ru.notexe.alive.data.FramesDatabase
import ru.notexe.alive.data.models.ChangeDto
import ru.notexe.alive.data.models.ColorPropertiesDto
import ru.notexe.alive.data.models.FrameDto
import ru.notexe.alive.data.models.PaintModeDto
import ru.notexe.alive.data.models.PaintObjectDto
import kotlin.math.min
import kotlin.random.Random
import kotlin.uuid.ExperimentalUuidApi
import kotlin.uuid.Uuid

internal class SettingsRepository(
    private val framesDao: FramesDao,
    private val framesDatabase: FramesDatabase,
    private val framesRepository: FramesRepository,
) {
    private val _generatedFramesCount = MutableStateFlow<Int>(0)
    val generatedFramesCount: Flow<Int> = _generatedFramesCount.asStateFlow()

    @OptIn(ExperimentalUuidApi::class)
    suspend fun startGenerate(count: Int) = withContext(Dispatchers.Default) {
        val changesString =
            "[{\"dragAmountX\":2.3654747,\"dragAmountY\":-2.215784},{\"dragAmountX\":5.583008,\"dragAmountY\":-7.373047},{\"dragAmountX\":6.758789,\"dragAmountY\":-8.75},{\"dragAmountX\":6.2333984,\"dragAmountY\":-8.239258},{\"dragAmountX\":4.2626953,\"dragAmountY\":-5.4345703},{\"dragAmountX\":4.1015625,\"dragAmountY\":-5.899414},{\"dragAmountX\":3.053711,\"dragAmountY\":-5.6523438},{\"dragAmountX\":2.022461,\"dragAmountY\":-5.1279297},{\"dragAmountX\":1.9658203,\"dragAmountY\":-4.915039},{\"dragAmountX\":3.0957031,\"dragAmountY\":-3.9736328},{\"dragAmountX\":1.9111328,\"dragAmountY\":-3.975586},{\"dragAmountX\":3.0771484,\"dragAmountY\":-5.0810547},{\"dragAmountX\":1.9130859,\"dragAmountY\":-3.8984375},{\"dragAmountX\":3.1103516,\"dragAmountY\":-5.140625},{\"dragAmountX\":1.8164062,\"dragAmountY\":-3.7128906},{\"dragAmountX\":2.0078125,\"dragAmountY\":-4.015625},{\"dragAmountX\":1.0244141,\"dragAmountY\":-4.2265625},{\"dragAmountX\":2.0771484,\"dragAmountY\":-2.8935547},{\"dragAmountX\":0.91503906,\"dragAmountY\":-2.9941406},{\"dragAmountX\":2.086914,\"dragAmountY\":-3.008789},{\"dragAmountX\":1.9931641,\"dragAmountY\":-1.9091797},{\"dragAmountX\":0.9248047,\"dragAmountY\":-3.0957031},{\"dragAmountX\":2.0800781,\"dragAmountY\":-2.9921875},{\"dragAmountX\":0.9169922,\"dragAmountY\":-1.9169922},{\"dragAmountX\":2.0830078,\"dragAmountY\":-3.0830078},{\"dragAmountX\":0.9199219,\"dragAmountY\":-1.9238281},{\"dragAmountX\":1.9765625,\"dragAmountY\":-2.9208984},{\"dragAmountX\":2.0917969,\"dragAmountY\":-3.1367188},{\"dragAmountX\":0.8769531,\"dragAmountY\":-2.8642578},{\"dragAmountX\":1.0429688,\"dragAmountY\":-3.1269531},{\"dragAmountX\":2.086914,\"dragAmountY\":-3.0195312},{\"dragAmountX\":0.9140625,\"dragAmountY\":-2.9853516},{\"dragAmountX\":2.0751953,\"dragAmountY\":-1.9238281},{\"dragAmountX\":0.9277344,\"dragAmountY\":-4.1621094},{\"dragAmountX\":0.9941406,\"dragAmountY\":-2.9042969},{\"dragAmountX\":2.0830078,\"dragAmountY\":-3.0166016},{\"dragAmountX\":2.0009766,\"dragAmountY\":-3.0009766},{\"dragAmountX\":0.9199219,\"dragAmountY\":-2.993164},{\"dragAmountX\":2.0673828,\"dragAmountY\":-2.9873047},{\"dragAmountX\":2.008789,\"dragAmountY\":-1.9375},{\"dragAmountX\":0.921875,\"dragAmountY\":-3.0703125},{\"dragAmountX\":1.0048828,\"dragAmountY\":-1.9355469},{\"dragAmountX\":2.0751953,\"dragAmountY\":-1.9960938},{\"dragAmountX\":-0.15429688,\"dragAmountY\":-2.006836},{\"dragAmountX\":2.1523438,\"dragAmountY\":-1.9912109},{\"dragAmountX\":0.93066406,\"dragAmountY\":-0.93066406},{\"dragAmountX\":0.9951172,\"dragAmountY\":-2.0742188},{\"dragAmountX\":0.99902344,\"dragAmountY\":-1.9970703},{\"dragAmountX\":0.9501953,\"dragAmountY\":-1.8994141},{\"dragAmountX\":1.0205078,\"dragAmountY\":-2.0419922},{\"dragAmountX\":1.0302734,\"dragAmountY\":-0.9814453},{\"dragAmountX\":2.0761719,\"dragAmountY\":-2.0771484},{\"dragAmountX\":0.8720703,\"dragAmountY\":-2.9238281},{\"dragAmountX\":2.1308594,\"dragAmountY\":-1.0},{\"dragAmountX\":0.9160156,\"dragAmountY\":-2.069336},{\"dragAmountX\":1.0019531,\"dragAmountY\":-2.0029297},{\"dragAmountX\":0.98339844,\"dragAmountY\":-1.9677734},{\"dragAmountX\":2.109375,\"dragAmountY\":-2.0498047},{\"dragAmountX\":0.8652344,\"dragAmountY\":-1.8984375},{\"dragAmountX\":1.0458984,\"dragAmountY\":-2.0908203},{\"dragAmountX\":0.9951172,\"dragAmountY\":-1.9902344},{\"dragAmountX\":1.0019531,\"dragAmountY\":-2.0048828},{\"dragAmountX\":0.9951172,\"dragAmountY\":-1.9902344},{\"dragAmountX\":1.0068359,\"dragAmountY\":-2.0146484},{\"dragAmountX\":0.9970703,\"dragAmountY\":-1.9931641},{\"dragAmountX\":2.0761719,\"dragAmountY\":-2.0009766},{\"dragAmountX\":0.86816406,\"dragAmountY\":-1.8886719},{\"dragAmountX\":1.0703125,\"dragAmountY\":-2.1396484},{\"dragAmountX\":0.9394531,\"dragAmountY\":-1.8789062},{\"dragAmountX\":1.0478516,\"dragAmountY\":-1.0185547},{\"dragAmountX\":0.95410156,\"dragAmountY\":-1.9853516},{\"dragAmountX\":1.0410156,\"dragAmountY\":-2.0820312},{\"dragAmountX\":2.0810547,\"dragAmountY\":-2.008789},{\"dragAmountX\":-0.15332031,\"dragAmountY\":-0.92871094},{\"dragAmountX\":1.0205078,\"dragAmountY\":-1.9599609},{\"dragAmountX\":2.147461,\"dragAmountY\":-2.125},{\"dragAmountX\":-0.16796875,\"dragAmountY\":-1.9951172},{\"dragAmountX\":1.0712891,\"dragAmountY\":-0.9091797},{\"dragAmountX\":1.0,\"dragAmountY\":-3.1425781},{\"dragAmountX\":1.0048828,\"dragAmountY\":-0.8623047},{\"dragAmountX\":0.99316406,\"dragAmountY\":-2.0634766},{\"dragAmountX\":-0.06933594,\"dragAmountY\":-0.9355469},{\"dragAmountX\":1.0722656,\"dragAmountY\":-2.0703125},{\"dragAmountX\":-0.072265625,\"dragAmountY\":-0.92578125},{\"dragAmountX\":1.078125,\"dragAmountY\":-1.0068359},{\"dragAmountX\":0.9941406,\"dragAmountY\":-0.9941406},{\"dragAmountX\":-0.072265625,\"dragAmountY\":-1.0},{\"dragAmountX\":0.0,\"dragAmountY\":-0.99316406},{\"dragAmountX\":1.0,\"dragAmountY\":-0.99609375},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0166016},{\"dragAmountX\":0.0,\"dragAmountY\":-0.921875},{\"dragAmountX\":1.0556641,\"dragAmountY\":0.0},{\"dragAmountX\":-0.055664062,\"dragAmountY\":-1.0888672},{\"dragAmountX\":1.0,\"dragAmountY\":3.336914},{\"dragAmountX\":1.0117188,\"dragAmountY\":0.7636719},{\"dragAmountX\":0.080078125,\"dragAmountY\":1.171875},{\"dragAmountX\":0.9082031,\"dragAmountY\":1.8974609},{\"dragAmountX\":0.0,\"dragAmountY\":2.1113281},{\"dragAmountX\":0.0,\"dragAmountY\":1.8515625},{\"dragAmountX\":0.0,\"dragAmountY\":2.1269531},{\"dragAmountX\":1.0283203,\"dragAmountY\":1.8847656},{\"dragAmountX\":-0.028320312,\"dragAmountY\":2.1015625},{\"dragAmountX\":0.0,\"dragAmountY\":3.0478516},{\"dragAmountX\":0.0,\"dragAmountY\":3.03125},{\"dragAmountX\":0.0,\"dragAmountY\":4.086914},{\"dragAmountX\":0.0,\"dragAmountY\":2.8632812},{\"dragAmountX\":0.0,\"dragAmountY\":3.9072266},{\"dragAmountX\":0.0,\"dragAmountY\":3.1347656},{\"dragAmountX\":1.0615234,\"dragAmountY\":4.017578},{\"dragAmountX\":-0.061523438,\"dragAmountY\":2.9375},{\"dragAmountX\":0.0,\"dragAmountY\":3.8867188},{\"dragAmountX\":0.0,\"dragAmountY\":3.1826172},{\"dragAmountX\":0.0,\"dragAmountY\":4.0498047},{\"dragAmountX\":0.0,\"dragAmountY\":3.961914},{\"dragAmountX\":0.0,\"dragAmountY\":2.9677734},{\"dragAmountX\":1.0703125,\"dragAmountY\":2.9785156},{\"dragAmountX\":-0.0703125,\"dragAmountY\":1.9306641},{\"dragAmountX\":1.0771484,\"dragAmountY\":3.0898438},{\"dragAmountX\":-0.07714844,\"dragAmountY\":1.9111328},{\"dragAmountX\":0.0,\"dragAmountY\":2.0302734},{\"dragAmountX\":0.0,\"dragAmountY\":0.8544922},{\"dragAmountX\":0.0,\"dragAmountY\":2.133789},{\"dragAmountX\":1.0703125,\"dragAmountY\":1.9794922},{\"dragAmountX\":-0.0703125,\"dragAmountY\":2.0029297},{\"dragAmountX\":0.0,\"dragAmountY\":1.9931641},{\"dragAmountX\":1.0791016,\"dragAmountY\":2.0214844},{\"dragAmountX\":-0.07910156,\"dragAmountY\":1.9755859},{\"dragAmountX\":0.0,\"dragAmountY\":2.0107422},{\"dragAmountX\":0.0,\"dragAmountY\":1.9941406},{\"dragAmountX\":1.0,\"dragAmountY\":2.0898438},{\"dragAmountX\":0.0,\"dragAmountY\":2.8388672},{\"dragAmountX\":0.0,\"dragAmountY\":2.0966797},{\"dragAmountX\":0.0,\"dragAmountY\":2.9160156},{\"dragAmountX\":0.0,\"dragAmountY\":2.0810547},{\"dragAmountX\":0.0,\"dragAmountY\":3.0566406},{\"dragAmountX\":0.0,\"dragAmountY\":3.0126953},{\"dragAmountX\":0.0,\"dragAmountY\":2.9970703},{\"dragAmountX\":0.0,\"dragAmountY\":1.9335938},{\"dragAmountX\":0.0,\"dragAmountY\":2.9082031},{\"dragAmountX\":-1.0859375,\"dragAmountY\":3.1894531},{\"dragAmountX\":0.0859375,\"dragAmountY\":2.9746094},{\"dragAmountX\":-1.0693359,\"dragAmountY\":2.9736328},{\"dragAmountX\":-0.95410156,\"dragAmountY\":1.8398438},{\"dragAmountX\":-1.0507812,\"dragAmountY\":3.1757812},{\"dragAmountX\":-1.0029297,\"dragAmountY\":3.0078125},{\"dragAmountX\":-1.0029297,\"dragAmountY\":1.9296875},{\"dragAmountX\":0.080078125,\"dragAmountY\":3.0722656},{\"dragAmountX\":0.0,\"dragAmountY\":2.9746094},{\"dragAmountX\":-1.0595703,\"dragAmountY\":2.9707031},{\"dragAmountX\":0.059570312,\"dragAmountY\":1.984375},{\"dragAmountX\":0.0,\"dragAmountY\":3.071289},{\"dragAmountX\":-1.0693359,\"dragAmountY\":2.9746094},{\"dragAmountX\":0.06933594,\"dragAmountY\":2.9990234},{\"dragAmountX\":0.0,\"dragAmountY\":1.9560547},{\"dragAmountX\":0.0,\"dragAmountY\":1.9892578},{\"dragAmountX\":-1.0664062,\"dragAmountY\":1.9804688},{\"dragAmountX\":0.06640625,\"dragAmountY\":2.0029297},{\"dragAmountX\":0.0,\"dragAmountY\":2.0107422},{\"dragAmountX\":-1.0,\"dragAmountY\":0.9238281},{\"dragAmountX\":0.0,\"dragAmountY\":1.9863281},{\"dragAmountX\":0.0,\"dragAmountY\":0.9785156},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0351562},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0644531},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9824219},{\"dragAmountX\":1.0771484,\"dragAmountY\":-2.0292969},{\"dragAmountX\":-0.07714844,\"dragAmountY\":-2.0664062},{\"dragAmountX\":0.0,\"dragAmountY\":-0.92578125},{\"dragAmountX\":0.0,\"dragAmountY\":-0.99609375},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0136719},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9980469},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0722656},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9248047},{\"dragAmountX\":-1.0664062,\"dragAmountY\":-2.0585938},{\"dragAmountX\":0.06640625,\"dragAmountY\":-0.9345703},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0927734},{\"dragAmountX\":-1.078125,\"dragAmountY\":-1.9960938},{\"dragAmountX\":0.078125,\"dragAmountY\":-2.0019531},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0058594},{\"dragAmountX\":-1.0830078,\"dragAmountY\":-3.0859375},{\"dragAmountX\":0.08300781,\"dragAmountY\":-1.9082031},{\"dragAmountX\":0.0,\"dragAmountY\":-1.9931641},{\"dragAmountX\":0.0,\"dragAmountY\":-1.9912109},{\"dragAmountX\":0.0,\"dragAmountY\":-4.1865234},{\"dragAmountX\":0.0,\"dragAmountY\":-2.9648438},{\"dragAmountX\":-0.072265625,\"dragAmountY\":-3.9941406},{\"dragAmountX\":-0.94140625,\"dragAmountY\":-3.7675781},{\"dragAmountX\":-1.0703125,\"dragAmountY\":-4.2822266},{\"dragAmountX\":0.083984375,\"dragAmountY\":-3.772461},{\"dragAmountX\":0.0,\"dragAmountY\":-4.208008},{\"dragAmountX\":0.0,\"dragAmountY\":-5.03125},{\"dragAmountX\":0.0,\"dragAmountY\":-2.8583984},{\"dragAmountX\":-1.0634766,\"dragAmountY\":-4.0458984},{\"dragAmountX\":0.06347656,\"dragAmountY\":-4.060547},{\"dragAmountX\":0.0,\"dragAmountY\":-3.9580078},{\"dragAmountX\":0.0,\"dragAmountY\":-3.9902344},{\"dragAmountX\":-1.0654297,\"dragAmountY\":-2.9335938},{\"dragAmountX\":0.06542969,\"dragAmountY\":-4.073242},{\"dragAmountX\":0.0,\"dragAmountY\":-2.930664},{\"dragAmountX\":0.0,\"dragAmountY\":-3.0078125},{\"dragAmountX\":0.0,\"dragAmountY\":-2.9804688},{\"dragAmountX\":0.0,\"dragAmountY\":-3.008789},{\"dragAmountX\":0.0,\"dragAmountY\":-3.0019531},{\"dragAmountX\":0.0,\"dragAmountY\":-3.008789},{\"dragAmountX\":0.0,\"dragAmountY\":-2.9814453},{\"dragAmountX\":0.0,\"dragAmountY\":-3.0410156},{\"dragAmountX\":0.0,\"dragAmountY\":-2.8076172},{\"dragAmountX\":0.0,\"dragAmountY\":-3.180664},{\"dragAmountX\":0.0,\"dragAmountY\":-2.9726562},{\"dragAmountX\":0.0,\"dragAmountY\":-3.0058594},{\"dragAmountX\":0.0,\"dragAmountY\":-2.9902344},{\"dragAmountX\":0.0,\"dragAmountY\":-1.9443359},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0029297},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0019531},{\"dragAmountX\":0.0,\"dragAmountY\":-2.9335938},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0820312},{\"dragAmountX\":0.0,\"dragAmountY\":-1.9853516},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9423828},{\"dragAmountX\":0.0,\"dragAmountY\":-1.9589844},{\"dragAmountX\":0.0,\"dragAmountY\":-2.116211},{\"dragAmountX\":1.0664062,\"dragAmountY\":-3.0439453},{\"dragAmountX\":-0.06640625,\"dragAmountY\":-0.8671875},{\"dragAmountX\":1.0683594,\"dragAmountY\":-3.1396484},{\"dragAmountX\":-0.068359375,\"dragAmountY\":-0.86621094},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0634766},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0},{\"dragAmountX\":0.0,\"dragAmountY\":-0.93847656},{\"dragAmountX\":1.0722656,\"dragAmountY\":-2.0703125},{\"dragAmountX\":-0.072265625,\"dragAmountY\":-0.9267578},{\"dragAmountX\":1.0615234,\"dragAmountY\":-2.053711},{\"dragAmountX\":-0.061523438,\"dragAmountY\":-0.9355469},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0136719},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9951172},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0029297},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9638672},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0048828},{\"dragAmountX\":0.0,\"dragAmountY\":-0.95996094},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0078125},{\"dragAmountX\":1.0,\"dragAmountY\":-0.9921875},{\"dragAmountX\":0.0,\"dragAmountY\":-1.0693359},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9970703},{\"dragAmountX\":0.0,\"dragAmountY\":-0.98828125},{\"dragAmountX\":0.0,\"dragAmountY\":-2.0126953},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9550781},{\"dragAmountX\":0.0,\"dragAmountY\":-3.1376953},{\"dragAmountX\":0.0,\"dragAmountY\":-0.875},{\"dragAmountX\":0.0,\"dragAmountY\":-1.03125},{\"dragAmountX\":0.0,\"dragAmountY\":-0.9511719},{\"dragAmountX\":-1.0,\"dragAmountY\":-0.9824219},{\"dragAmountX\":-1.0,\"dragAmountY\":0.0},{\"dragAmountX\":-1.0,\"dragAmountY\":0.0},{\"dragAmountX\":-1.0087891,\"dragAmountY\":0.0},{\"dragAmountX\":-1.0615234,\"dragAmountY\":0.0},{\"dragAmountX\":-0.94433594,\"dragAmountY\":0.0},{\"dragAmountX\":-1.0595703,\"dragAmountY\":1.0},{\"dragAmountX\":-0.9511719,\"dragAmountY\":0.025390625},{\"dragAmountX\":-1.1171875,\"dragAmountY\":1.0458984},{\"dragAmountX\":-2.0029297,\"dragAmountY\":1.0742188},{\"dragAmountX\":-2.0009766,\"dragAmountY\":2.0009766},{\"dragAmountX\":-1.8789062,\"dragAmountY\":1.8789062},{\"dragAmountX\":-3.2050781,\"dragAmountY\":1.0517578},{\"dragAmountX\":-6.088867,\"dragAmountY\":6.1621094},{\"dragAmountX\":-2.90625,\"dragAmountY\":1.9111328},{\"dragAmountX\":-2.96875,\"dragAmountY\":3.0439453},{\"dragAmountX\":-3.0039062,\"dragAmountY\":4.0703125},{\"dragAmountX\":-4.084961,\"dragAmountY\":2.9472656},{\"dragAmountX\":-2.9101562,\"dragAmountY\":2.9814453},{\"dragAmountX\":-4.0751953,\"dragAmountY\":4.0751953},{\"dragAmountX\":-3.9882812,\"dragAmountY\":2.9248047},{\"dragAmountX\":-4.0029297,\"dragAmountY\":4.0664062},{\"dragAmountX\":-3.9921875,\"dragAmountY\":3.9921875},{\"dragAmountX\":-4.0126953,\"dragAmountY\":4.0126953},{\"dragAmountX\":-3.9951172,\"dragAmountY\":3.9951172},{\"dragAmountX\":-2.9228516,\"dragAmountY\":2.9228516},{\"dragAmountX\":-3.8984375,\"dragAmountY\":2.8779297},{\"dragAmountX\":-3.1953125,\"dragAmountY\":3.1464844},{\"dragAmountX\":-3.9863281,\"dragAmountY\":2.9902344},{\"dragAmountX\":-2.9794922,\"dragAmountY\":4.1259766},{\"dragAmountX\":-2.9677734,\"dragAmountY\":1.8164062},{\"dragAmountX\":-4.057617,\"dragAmountY\":3.0605469},{\"dragAmountX\":-2.7832031,\"dragAmountY\":2.850586},{\"dragAmountX\":-3.1396484,\"dragAmountY\":3.1396484},{\"dragAmountX\":-3.0117188,\"dragAmountY\":1.9443359},{\"dragAmountX\":-3.0263672,\"dragAmountY\":2.0175781},{\"dragAmountX\":-4.0390625,\"dragAmountY\":3.0488281},{\"dragAmountX\":-1.8691406,\"dragAmountY\":1.9355469},{\"dragAmountX\":-3.0585938,\"dragAmountY\":0.92871094},{\"dragAmountX\":-1.9443359,\"dragAmountY\":1.0048828},{\"dragAmountX\":-1.9921875,\"dragAmountY\":2.0615234},{\"dragAmountX\":-2.0,\"dragAmountY\":2.0},{\"dragAmountX\":-0.89453125,\"dragAmountY\":0.8808594},{\"dragAmountX\":-2.1201172,\"dragAmountY\":1.0605469},{\"dragAmountX\":-1.9785156,\"dragAmountY\":0.9892578},{\"dragAmountX\":-0.9433594,\"dragAmountY\":1.0058594},{\"dragAmountX\":-2.0439453,\"dragAmountY\":0.9873047},{\"dragAmountX\":-0.9472656,\"dragAmountY\":-0.055664062},{\"dragAmountX\":-1.0029297,\"dragAmountY\":1.0625},{\"dragAmountX\":-1.0136719,\"dragAmountY\":1.0136719},{\"dragAmountX\":-2.0644531,\"dragAmountY\":-0.076171875},{\"dragAmountX\":-0.9345703,\"dragAmountY\":1.0751953},{\"dragAmountX\":-0.99121094,\"dragAmountY\":0.99121094},{\"dragAmountX\":-0.9501953,\"dragAmountY\":0.9501953},{\"dragAmountX\":-1.0595703,\"dragAmountY\":-0.016601562},{\"dragAmountX\":-1.0039062,\"dragAmountY\":0.080078125},{\"dragAmountX\":-0.9951172,\"dragAmountY\":0.9951172},{\"dragAmountX\":-0.9902344,\"dragAmountY\":-0.07519531},{\"dragAmountX\":-1.0117188,\"dragAmountY\":1.0771484},{\"dragAmountX\":-0.9628906,\"dragAmountY\":-0.07714844},{\"dragAmountX\":0.040039062,\"dragAmountY\":1.0751953},{\"dragAmountX\":-1.0419922,\"dragAmountY\":-0.07519531},{\"dragAmountX\":-1.0234375,\"dragAmountY\":0.0},{\"dragAmountX\":0.06542969,\"dragAmountY\":1.0722656},{\"dragAmountX\":0.0,\"dragAmountY\":-1.1464844}]"
        val changes = Json.decodeFromString<List<ChangeDto>>(changesString)
        val offset = Offset(86.15137F, 1745.0605F)
        var offsetSaltX = 0f
        var offsetSaltY = 0f
        val frames = MutableList(PACK_SIZE) { FrameDto(0) }
        val paintObjects = MutableList<PaintObjectDto>(PACK_SIZE) {
            PaintObjectDto(
                "", 0, 0f, 0f, listOf(),
                ColorPropertiesDto(0f, 0f, 0f, 1f),
                paintMode = PaintModeDto.PENCIL,
                strokeWidth = 10f,
            )
        }
        repeat(PACK_SIZE) { i ->
            paintObjects[i] = PaintObjectDto(
                id = Uuid.random().toString(),
                frameId = 0,
                startX = offset.x + offsetSaltX,
                startY = offset.y - offsetSaltY,
                changes = changes,
                colorProperties = ColorPropertiesDto(0f, 0f, 0f, 1f),
                strokeWidth = 6f,
                paintMode = PaintModeDto.PENCIL,
            )
            offsetSaltX += (Random.nextFloat() * 10 % 100f)
            offsetSaltY += (Random.nextFloat() * 10 % 100f)
            if (offsetSaltX >= 200f) {
                offsetSaltX = 0f
            }
            if (offsetSaltY >= 500f) {
                offsetSaltY = 0f
            }
        }

        var currentCount = count
        while (currentCount > 0) {
            framesDatabase.withTransaction {
                framesDao.insertPaintObjects(
                    if (currentCount < PACK_SIZE) {
                        framesDao.addFrames(frames.subList(0, count % PACK_SIZE)).mapIndexed { index, id ->
                            paintObjects[index].copy(id = Uuid.random().toString(), frameId = id)
                        }
                    } else {
                        framesDao.addFrames(frames).mapIndexed { index, id ->
                            paintObjects[index].copy(id = Uuid.random().toString(), frameId = id)
                        }
                    }
                )
            }
            _generatedFramesCount.update { count -> count + min(currentCount, PACK_SIZE) }
            currentCount -= PACK_SIZE
        }
    }

    suspend fun deleteAll() = withContext(Dispatchers.IO) {
        framesDao.deleteAll()
        framesRepository.clearCurrentPack()
    }

    companion object {
        const val PACK_SIZE = 1000
    }
}